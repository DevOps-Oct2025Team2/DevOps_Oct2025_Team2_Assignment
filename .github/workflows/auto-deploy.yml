name: Production Auto Deploy to EC2

on:
  push:
    branches:
      - main

concurrency:
  group: production-deploy
  cancel-in-progress: true

jobs:
  deploy:
    name: Deploy to EC2
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Deploy to EC2 (with rollback and health check)
        id: deploy
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            set -e

            APP_DIR="/home/ubuntu/DevOps_Oct2025_Team2_Assignment-"
            SERVICE_DIR="$APP_DIR/auth-service"

            cd $APP_DIR

            # Save current commit for rollback
            git rev-parse HEAD > .previous_commit

            # Fetch and reset to latest main
            git fetch origin
            git reset --hard origin/main

            # Create production environment file
            cat > $SERVICE_DIR/.env <<EOF
            ENABLE_RUNTIME_EMAILS=true
            EMAIL_RATE_LIMIT_SECONDS=60
            SMTP_USERNAME=${{ secrets.SMTP_USERNAME }}
            SMTP_PASSWORD=${{ secrets.SMTP_PASSWORD }}
            EMAIL_FROM=${{ secrets.EMAIL_FROM }}
            EMAIL_TEAM=${{ secrets.EMAIL_TEAM }}
            EMAIL_DEV=${{ secrets.EMAIL_DEV }}
            EMAIL_QA=${{ secrets.EMAIL_QA }}
            APP_ENV=production
            EOF

            # Restart services
            docker-compose down
            docker-compose up -d --build

            # Wait for service to initialise
            sleep 15

            # Health check
            HEALTH=$(curl -s http://localhost:5000/health | grep ok || echo fail)

            if [ "$HEALTH" = "fail" ]; then
              echo "Health check failed. Rolling back."

              git reset --hard $(cat .previous_commit)
              docker-compose down
              docker-compose up -d --build

              exit 1
            fi

            echo "Deployment successful."

      - name: Send Success Email
        if: steps.deploy.outcome == 'success'
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 587
          secure: false
          username: ${{ secrets.SMTP_USERNAME }}
          password: ${{ secrets.SMTP_PASSWORD }}
          subject: "Production Deployment Successful"
          to: ${{ secrets.EMAIL_TEAM }}
          from: "CI Bot <${{ secrets.SMTP_USERNAME }}>"
          body: |
            Production deployment completed successfully.

            Repository: ${{ github.repository }}
            Branch: main
            Commit: ${{ github.sha }}

      - name: Send Failure Email
        if: failure()
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 587
          secure: false
          username: ${{ secrets.SMTP_USERNAME }}
          password: ${{ secrets.SMTP_PASSWORD }}
          subject: "Production Deployment Failed (Rollback Executed)"
          to: ${{ secrets.EMAIL_TEAM }}
          from: "CI Bot <${{ secrets.SMTP_USERNAME }}>"
          body: |
            Production deployment failed.

            A rollback was executed automatically.

            Repository: ${{ github.repository }}
            Branch: main
            Commit: ${{ github.sha }}

            Check logs:
            ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
