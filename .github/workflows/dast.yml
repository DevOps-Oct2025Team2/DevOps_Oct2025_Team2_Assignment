# DAST - Dynamic Application Security Testing with OWASP ZAP
name: DAST - OWASP ZAP Security Scan

on:
  push:
    branches: [ main, qa/qa, dev ]
  pull_request:
    branches: [ main, qa/qa, dev ]
  workflow_dispatch:

permissions:
  contents: read
  security-events: write
  issues: write

jobs:
  dast-scan:
    name: OWASP ZAP DAST Scan
    runs-on: ubuntu-latest

    steps:
      # Step 1: Checkout source code
      - name: Checkout repository
        uses: actions/checkout@v4

      # Step 2: Start services
      - name: Start services with Docker Compose
        run: |
          docker compose up -d
          echo "Waiting for services to initialise..."
          sleep 20

      # Step 3: Verify services are running
      - name: Check service health
        run: |
          curl -f http://localhost:5000/health || echo "Auth not ready"
          curl -f http://localhost:5002/health || echo "File not ready"
          curl -f http://localhost:3000/health || echo "UI not ready"

      # Step 4: ZAP Baseline Scan - UI Gateway
      - name: ZAP Baseline Scan - UI Gateway
        uses: zaproxy/action-baseline@v0.12.0
        with:
          target: 'http://localhost:3000'
          cmd_options: '-a -j -l WARN'
          allow_issue_writing: false
          artifact_name: none

      - name: Rename UI reports
        run: |
          mv report_json.json zap-ui.json
          mv report_md.md zap-ui.md
          mv report_html.html zap-ui.html

      # Step 5: ZAP API Scan - Auth Service
      - name: ZAP API Scan - Auth Service
        uses: zaproxy/action-api-scan@v0.7.0
        with:
          target: 'auth-service/openapi.yaml'
          format: 'openapi'
          cmd_options: '-a -j -l WARN'
          allow_issue_writing: false
          artifact_name: none

      - name: Rename Auth API reports
        run: |
          mv report_json.json zap-api-auth.json
          mv report_md.md zap-api-auth.md
          mv report_html.html zap-api-auth.html

      # Step 6: ZAP API Scan - File Service
      - name: ZAP API Scan - File Service
        uses: zaproxy/action-api-scan@v0.7.0
        with:
          target: 'file-service/openapi.yaml'
          format: 'openapi'
          cmd_options: '-a -j -l WARN'
          allow_issue_writing: false
          artifact_name: none

      - name: Rename File API reports
        run: |
          mv report_json.json zap-api-file.json
          mv report_md.md zap-api-file.md
          mv report_html.html zap-api-file.html

      # Step 7: Enforce policy gate (FAIL on High only)
      - name: Enforce High-only DAST policy gate
        run: |
          python - <<'PY'
          import json, glob, sys

          reports = glob.glob("zap-*.json")
          if not reports:
              print("No ZAP reports found")
              sys.exit(1)

          highs = []
          for r in reports:
              with open(r, encoding="utf-8") as f:
                  data = json.load(f)
              for site in data.get("site", []):
                  for alert in site.get("alerts", []):
                      if alert.get("risk", "").lower() == "high":
                          highs.append((alert.get("alert"), alert.get("url")))

          if highs:
              print("High severity vulnerabilities found:")
              for h in highs:
                  print(f"- {h[0]} at {h[1]}")
              sys.exit(1)

          print("DAST policy gate passed: no High severity issues found.")
          PY

      # Step 8: Upload all reports (single artifact container)
      - name: Upload DAST reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: dast-zap-reports
          path: |
            zap-*.html
            zap-*.json
            zap-*.md

      # Step 9: Cleanup
      - name: Stop services
        if: always()
        run: |
          docker compose down -v
